!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(e="undefined"!=typeof globalThis?globalThis:e||self).IdevViewer=s()}(this,function(){"use strict";class e{constructor(e={}){this.options={width:"100%",height:"600px",template:null,config:{},onReady:null,onError:null,onStateUpdate:null,onTemplateUpdated:null,onConfigUpdated:null,onApiResponse:null,onStreamData:null,onItemTap:null,onItemEdit:null,autoCreateIframe:!0,autoSetupMessageHandlers:!0,idevAppPath:"./idev-app/",...e},this.iframe=null,this.isReady=!1,this.messageQueue=new Map,this.messageHandlers=new Map,this.streamSubscriptions=new Map,this.apiCallbacks=new Map,this.requestId=0,this.eventListeners=new Map,this.options.autoSetupMessageHandlers&&this._setupMessageHandlers(),this.options.autoCreateIframe&&this._createIframe()}_setupMessageHandlers(){this.messageHandlers.set("ready",e=>{this.isReady=!0,this.options.onReady&&this.options.onReady(e),this._processMessageQueue()}),this.messageHandlers.set("success",e=>{console.log("Success:",e.message)}),this.messageHandlers.set("error",e=>{console.error("Error:",e.message),this.options.onError&&this.options.onError(e.message)}),this.messageHandlers.set("stream_data",e=>{const{streamType:s,callbackId:t,data:i}=e;this.streamSubscriptions.has(t)&&this.streamSubscriptions.get(t)(i),this.options.onStreamData&&this.options.onStreamData(s,i)}),this.messageHandlers.set("api_response",e=>{this.options.onApiResponse&&this.options.onApiResponse(e)}),this.messageHandlers.set("item_tap",e=>{this.options.onItemTap&&this.options.onItemTap(e)}),this.messageHandlers.set("item_edit",e=>{this.options.onItemEdit&&this.options.onItemEdit(e)}),this.messageHandlers.set("json_menu_update",e=>{this.options.onTemplateUpdated&&this.options.onTemplateUpdated(e)}),this.messageHandlers.set("api_menu_update",e=>{this.options.onConfigUpdated&&this.options.onConfigUpdated(e)}),this.messageHandlers.set("flutter-ready",e=>{console.log("Flutter 앱 준비 완료:",e),this.isReady=!0,this._processMessageQueue(),this.options.onReady&&this.options.onReady(e)}),this.messageHandlers.set("flutter-error",e=>{console.error("Flutter 앱 오류:",e),this.options.onError&&this.options.onError(e.error||"Flutter 앱 오류 발생")})}_createIframe(){const e=this.options.idevAppPath||"./idev-app/";this.iframe=document.createElement("iframe"),this.iframe.src=e,this.iframe.width=this.options.width,this.iframe.height=this.options.height,this.iframe.frameBorder="0",this.iframe.style.border="none",this.iframe.style.borderRadius="8px",this.iframe.style.boxShadow="0 2px 10px rgba(0,0,0,0.1)",this.iframe.allow="clipboard-write",this.iframe.title="IDev Viewer",this.iframe.onload=()=>{console.log("iframe 로드 완료:",this.iframe.src),this._initializeViewer()},this.iframe.onerror=e=>{console.error("iframe 로드 오류:",e)},window.addEventListener("message",e=>{this._handleMessage(e)})}_handleMessage(e){try{let s;if("string"==typeof e.data)s=JSON.parse(e.data);else{if("object"!=typeof e.data)return void console.error("Invalid message data type:",typeof e.data);s=e.data}if(!s.type)return void console.warn("메시지 타입이 없습니다:",s);const t=this.messageHandlers.get(s.type);t?t(s.data||s):console.log("Unknown message type:",s.type,"Data:",s)}catch(s){console.error("Failed to parse message:",s),console.error("Message data:",e.data),console.error("Message data type:",typeof e.data)}}_initializeViewer(){this.options.template&&this.updateTemplate(this.options.template),this.options.config&&this.updateConfig(this.options.config)}_sendMessage(e,s={}){const t={type:e,...s,timestamp:Date.now()};this.isReady&&this.iframe?.contentWindow?this.iframe.contentWindow.postMessage(JSON.stringify(t),"*"):this.messageQueue.set(t.timestamp,t)}_processMessageQueue(){for(;this.messageQueue.size>0;){const e=this.messageQueue.values().next().value;this.messageQueue.delete(e.timestamp),this.iframe?.contentWindow&&this.iframe.contentWindow.postMessage(JSON.stringify(e),"*")}}updateTemplate(e){this._sendMessage("update_template",{template:e})}updateConfig(e){this._sendMessage("update_config",{config:e})}requestApi(e,s,t={},i={}){const a=++this.requestId;return new Promise((r,o)=>{this.apiCallbacks.set(a,{resolve:r,reject:o}),this._sendMessage("api_request",{method:e,apiId:s,params:t,requestId:a,...i}),setTimeout(()=>{this.apiCallbacks.has(a)&&(this.apiCallbacks.delete(a),o(new Error("API request timeout")))},i.timeout||3e4)})}subscribeToStream(e,s){const t=`stream_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return this.streamSubscriptions.set(t,s),this._sendMessage("subscribe_stream",{streamType:e,callbackId:t}),t}unsubscribeFromStream(e){this.streamSubscriptions.delete(e),this._sendMessage("unsubscribe_stream",{callbackId:e})}addEventListener(e,s){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(s)}removeEventListener(e,s){if(this.eventListeners.has(e)){const t=this.eventListeners.get(e),i=t.indexOf(s);i>-1&&t.splice(i,1)}}getState(){this._sendMessage("get_state")}resize(e,s){this._sendMessage("resize",{width:e,height:s}),this.iframe&&(this.iframe.width=e,this.iframe.height=s)}destroy(){this.iframe&&this.iframe.parentNode&&this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,this.isReady=!1,this.streamSubscriptions.clear(),this.apiCallbacks.clear(),this.eventListeners.clear()}createIframe(){this.iframe?console.warn("Iframe already exists"):this._createIframe()}setupMessageHandlers(){this.messageHandlers.size>0?console.warn("Message handlers already set up"):this._setupMessageHandlers()}hasIframe(){return null!==this.iframe}removeIframe(){this.iframe&&this.iframe.parentNode&&this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,this.isReady=!1}mount(e){if("string"==typeof e&&(e=document.querySelector(e)),!e)throw new Error("Container not found");this.iframe||this._createIframe(),e.appendChild(this.iframe)}getHTML(){return this.iframe.outerHTML}static getVersion(){return"1.0.0"}static isSupported(){return"undefined"!=typeof window&&window.postMessage}}return"undefined"!=typeof window&&(window.IdevViewer=e),"undefined"!=typeof module&&module.exports&&(module.exports=e),"function"==typeof define&&define.amd&&define([],function(){return e}),e});
//# sourceMappingURL=idev-viewer.js.map
